MACHINE ?= "raspberrypi4-64"

DL_DIR ?= "/home/isaac/poky/downloads"
SSTATE_DIR ?= "/home/isaac/poky/sstate-cache"
UNINATIVE_DLDIR ?= "${DL_DIR}/uninative"
DISTRO ?= "poky"

INHERIT += "rm_work"

IMAGE_INSTALL:append = " \
    gpio gpio-adapter-python python3-ctypes \
    python3 \
    python3-requests python3-pyserial python3-smbus2 python3-gpiod \
    python3-flask \
    iw \
    wpa-supplicant wpa-supplicant-cli \
    linux-firmware \
    dhcpcd net-tools ethtool \
    openssh \
    nano \
    connect-wifi \
    python3-picamera2 \
    libcamera libcamera-apps python3-libcamera \
    python3-numpy opencv \
    ffmpeg \
    v4l-utils \
    i2c-tools \
    kernel-module-i2c-dev \
    kernel-module-bcm2835-isp kernel-module-bcm2835-unicam kernel-module-ov5647 \
"

# i2c-bcm2835 es built-in → no lo intentes instalar
IMAGE_INSTALL:remove = " kernel-module-i2c-bcm2835 "
BAD_RECOMMENDATIONS += " kernel-module-i2c-bcm2835 "
PACKAGE_EXCLUDE   += " kernel-module-i2c-bcm2835 "

# Autoload de módulos presentes como módulos
KERNEL_MODULE_AUTOLOAD:append = " i2c-dev bcm2835-isp bcm2835-unicam ov5647"

IMAGE_FEATURES += " ssh-server-openssh "
EXTRA_IMAGE_FEATURES += " debug-tweaks "

IMAGE_ROOTFS_SIZE ?= "2200000"
IMAGE_OVERHEAD_FACTOR = "1.0"
IMAGE_ROOTFS_EXTRA_SPACE = "524288"

LICENSE_FLAGS_ACCEPTED += "synaptics-killswitch commercial"

# Escribe líneas reales en config.txt (usar saltos de línea)
RPI_EXTRA_CONFIG:append = "\n dtoverlay=vc4-kms-v3d\n dtoverlay=ov5647\n dtparam=i2c_vc=on\n"

# Pide al kernel que deploee el overlay en /boot/overlays
RPI_KERNEL_DEVICETREE_OVERLAYS:append = " overlays/ov5647.dtbo"

# (Plan B SOLO si no aparece el archivo en el .wic)
# IMAGE_BOOT_FILES:append = " overlays/ov5647.dtbo;overlays/ "

# Evitar choque con receta antigua
BBMASK += ".*/meta-raspberrypi/dynamic-layers/multimedia-layer/recipes-multimedia/libcamera-apps/.*"

CONF_VERSION = "2"
BB_NUMBER_THREADS = "12"

INHERIT:remove = "spdx"

